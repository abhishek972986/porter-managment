import { useState, useEffect } from 'react';

interface FormData {
  brigade: string;
  unitName: string;
  financialYear: string;
  brigadeName: string;
  letterNo: string;
  date: string;
  remarks: string;
}

const App = () => {
  const [formData, setFormData] = useState<FormData>({
    brigade: '',
    unitName: '',
    financialYear: '',
    brigadeName: '',
    letterNo: '',
    date: '',
    remarks: '',
  });

  const [savedForms, setSavedForms] = useState<(FormData & { id: number; timestamp: string })[]>([]);
  const [showSuccess, setShowSuccess] = useState(false);

  useEffect(() => {
    const saved = localStorage.getItem('militaryForms');
    if (saved) {
      setSavedForms(JSON.parse(saved));
    }
  }, []);

  const handleChange = (e: React.ChangeEvent<HTMLInputElement | HTMLSelectElement | HTMLTextAreaElement>) => {
    setFormData({ ...formData, [e.target.name]: e.target.value });
  };

  const downloadPDF = async (form: FormData & { id: number; timestamp: string }) => {
    const prettyDate = form.date ? new Date(form.date).toLocaleDateString('en-GB') : '';
    const safeUnit = (form.unitName || 'unit').replace(/\s+/g, '-');
    const html = `<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Filled Document Index</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", Arial, "Noto Sans", sans-serif; background: #f8fafc; color: #0f172a; margin: 0; }
    .wrap { max-width: 900px; margin: 40px auto; background: #fff; border: 1px solid #e5e7eb; border-radius: 16px; padding: 28px; }
    h1 { text-align: center; font-size: 24px; margin: 0 0 16px; }
    .subtitle { text-align: center; color: #475569; margin-bottom: 24px; }
    ol { line-height: 1.7; color: #334155; }
    li { margin: 10px 0; }
    .tag { background: #e0f2fe; color: #0369a1; padding: 2px 6px; border-radius: 6px; font-weight: 600; }
    .footer { margin-top: 24px; padding-top: 12px; border-top: 1px solid #e5e7eb; color: #64748b; font-size: 14px; }
  </style>
  </head>
  <body>
    <div class="wrap">
      <h1>INDEX</h1>
      <div class="subtitle">Auto-generated from saved form data</div>
      <ol>
        <li>Sanction of Commander, <span class="tag">${form.brigade}</span> Group.</li>
        <li>Recommendation of Commanding Officer, <span class="tag">${form.unitName}</span>.</li>
        <li>Board Proceedings (IAFD-931) for the FY <span class="tag">${form.financialYear}</span>.</li>
        <li>S of C for obtaining advance sanction of CFA signed by Imprest holder and countersigned by CO. Appx ‘A’</li>
        <li>Detailed staff checks of ration, stores and water load duly signed by BOO and countersigned by CO for carriage of load. Appx ‘B’ & ‘C’</li>
        <li>Detailed justification for anticipated increase in expenditure of porter and ponies employed by <span class="tag">${form.unitName}</span> duly signed by Imprest holder and countersigned by CO. Appx ‘D’</li>
        <li>Auth for new nerrick rates viz, BRO and connected documents. Appx ‘E’</li>
        <li>Certificate signed by Imprest holder and countersigned by CO confirming that the funds would not be utilized for carriage/tn of Engr/Def/Op Wks Stores/CSD Stores. Appx ‘F’</li>
        <li>Monthly expenditure incurred for hiring of porters and ponies for last two/three years duly signed by Imprest Holder and countersigned by CO. Appx ‘G’</li>
        <li>Certificate of Imprest Holder duly countersigned by CO for expenditure incurred in the last three months with reasons for increase in expenditure. Appx ‘H’</li>
        <li>State of Availability of Funds. Appx ‘J’</li>
        <li>Certificate regarding no Booking of Expenditure. Appx ‘K’</li>
        <li>Certificate of no discrepancies in the documents duly countersigned by CO. Appx ‘L’</li>
        <li>Certificate for payment of amount through Bank Account in r/o Porters. Appx ‘M’</li>
        <li>Certificate for Parameters adopted to determine number of trips by Porters. Appx ‘N’</li>
        <li>BOO for obtaining Pre-Sanction of CFA vide <span class="tag">${form.brigadeName}</span> letter No <span class="tag">${form.letterNo}</span>${prettyDate ? ` dt <span class="tag">${prettyDate}</span>` : ''}. Appx ‘O’</li>
      </ol>
      ${prettyDate ? `<div class="footer"><strong>Date:</strong> ${prettyDate}</div>` : ''}
      ${form.remarks ? `<div class="footer"><strong>Remarks:</strong> ${form.remarks}</div>` : ''}
    </div>
  </body>
</html>`;

      // Get PDF blob from response
      const blob = await response.blob();
      
      // Create download link and trigger download
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      const safeUnit = (form.unitName || 'unit').replace(/\s+/g, '-');
      a.href = url;
      a.download = `document-${safeUnit}-${Date.now()}.pdf`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    } catch (error) {
      console.error('Error downloading PDF:', error);
      alert('Failed to generate PDF. Please make sure the backend server is running on port 3001.');
    }
  };

  const handleSubmit = (e: React.FormEvent) => {
    e.preventDefault();
    const newEntry = { ...formData, id: Date.now(), timestamp: new Date().toLocaleString() };
    const updatedForms = [...savedForms, newEntry];
    setSavedForms(updatedForms);
    localStorage.setItem('militaryForms', JSON.stringify(updatedForms));
    downloadPDF(newEntry);
    setShowSuccess(true);
    setTimeout(() => setShowSuccess(false), 3000);
    setFormData({ brigade: '', unitName: '', financialYear: '', brigadeName: '', letterNo: '', date: '', remarks: '' });
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-100 flex items-center justify-center p-4">
      {showSuccess && (
        <div className="fixed top-6 right-6 bg-green-500 text-white px-6 py-4 rounded-lg shadow-xl z-50 flex items-center gap-3">
          <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M5 13l4 4L19 7"></path>
          </svg>
          <span className="font-medium">Form saved successfully!</span>
        </div>
      )}

      <div className="w-full max-w-2xl bg-white rounded-2xl shadow-2xl p-8 border border-gray-100">
        <div className="flex items-center gap-3 mb-6 pb-4 border-b border-gray-200">
          <div className="bg-blue-100 p-3 rounded-lg">
            <svg className="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
            </svg>
          </div>
          <div>
            <h2 className="text-2xl font-bold text-gray-800">Fill Details</h2>
            <p className="text-sm text-gray-500">Complete the form below</p>
          </div>
        </div>

        <form onSubmit={handleSubmit} className="space-y-5">
          <div>
            <label className="block text-sm font-semibold text-gray-700 mb-2">Infantry Brigade *</label>
            <select name="brigade" value={formData.brigade} onChange={handleChange} required className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all bg-white text-gray-800">
              <option value="">Select Brigade</option>
              <option value="121 (Independent) Infantry Brigade">121 (Independent) Infantry Brigade</option>
              <option value="122 Infantry Brigade">122 Infantry Brigade</option>
              <option value="123 Infantry Brigade">123 Infantry Brigade</option>
            </select>
          </div>

          <div>
            <label className="block text-sm font-semibold text-gray-700 mb-2">Unit Name *</label>
            <select name="unitName" value={formData.unitName} onChange={handleChange} required className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all bg-white text-gray-800">
              <option value="">Select Unit</option>
              <option value="UnitNameKaraj">UnitNameKaraj</option>
              <option value="UnitNamePune">UnitNamePune</option>
              <option value="UnitNameMumbai">UnitNameMumbai</option>
            </select>
          </div>

          <div>
            <label className="block text-sm font-semibold text-gray-700 mb-2">Financial Year *</label>
            <select name="financialYear" value={formData.financialYear} onChange={handleChange} required className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all bg-white text-gray-800">
              <option value="">Select FY</option>
              <option value="2024-25">2024-25</option>
              <option value="2025-26">2025-26</option>
              <option value="2026-27">2026-27</option>
            </select>
          </div>

          <div>
            <label className="block text-sm font-semibold text-gray-700 mb-2">Brigade Group *</label>
            <select name="brigadeName" value={formData.brigadeName} onChange={handleChange} required className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all bg-white text-gray-800">
              <option value="">Select Group</option>
              <option value="NAME OF Bde Gp">NAME OF Bde Gp</option>
              <option value="OTHER Bde Gp">OTHER Bde Gp</option>
            </select>
          </div>

          <div>
            <label className="block text-sm font-semibold text-gray-700 mb-2">Letter Number *</label>
            <input type="text" name="letterNo" value={formData.letterNo} placeholder="e.g., 508/Q/S&S/1 dt 08 Mar 2025" onChange={handleChange} required className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all" />
          </div>

          <div>
            <label className="block text-sm font-semibold text-gray-700 mb-2">Date *</label>
            <input type="date" name="date" value={formData.date} onChange={handleChange} required className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all" />
          </div>

          <div>
            <label className="block text-sm font-semibold text-gray-700 mb-2">Remarks</label>
            <textarea name="remarks" value={formData.remarks} onChange={handleChange} rows={3} placeholder="Enter any additional remarks..." className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all resize-none" />
          </div>

          <div className="flex gap-3 pt-4">
            <button type="submit" className="flex-1 bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white font-semibold py-3 px-6 rounded-lg shadow-lg hover:shadow-xl transition-all duration-200 flex items-center justify-center gap-2">
              <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M5 13l4 4L19 7"></path>
              </svg>
              Submit
            </button>
            <button type="button" onClick={() => setFormData({ brigade: '', unitName: '', financialYear: '', brigadeName: '', letterNo: '', date: '', remarks: '' })} className="px-6 py-3 border-2 border-gray-300 text-gray-700 font-semibold rounded-lg hover:bg-gray-50 transition-all duration-200">
              Clear
            </button>
            <a href="/view-data.html" className="px-6 py-3 bg-gray-800 hover:bg-gray-900 text-white font-semibold rounded-lg transition-all duration-200 flex items-center gap-2">
              <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
              </svg>
              View Saved Forms
            </a>
          </div>
        </form>
      </div>
    </div>
  );
};

export default App;
